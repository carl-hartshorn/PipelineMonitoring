variables:
  major: 0
  minor: 0
  patch: $[counter(format('major {0} minor {1}', variables['major'], variables['minor']), 1)]

name: $[format('{0}.{1}.{2}', variables['major'], variables['minor'], variables['patch'])]

resources:
  - repo: self
    clean: true

trigger:
  - main

steps:
  - task: DotNetCoreCLI@2
    displayName: 'dotnet build'
    inputs:
      command: 'build'
      projects: '**/*.csproj'
      arguments: '-c Release /p:Version=$(Build.BuildNumber)'

  - task: DotNetCoreCLI@2
    displayName: 'dotnet test'
    inputs:
      command: 'test'
      projects: '**/*.UnitTests.csproj'
      arguments: '-c Release --no-build'
  
  - task: DotNetCoreCLI@2
    displayName: 'dotnet publish'
    inputs:
      command: 'publish'
      publishWebProjects: true
      zipAfterPublish: false
      modifyOutputPath: false
      arguments: '-c Release'

  - task: PowerShell@2
    displayName: 'Deploy to Firebase'
    inputs:
      targetType: 'inline'
      script: |
        cd $(Build.Repository.LocalPath)
        npm install firebase-tools
        npx firebase deploy --token $(FirebaseToken)